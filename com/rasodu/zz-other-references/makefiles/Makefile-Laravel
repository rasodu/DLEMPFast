#Steps to deploy
#1. copy this file to root of your project
#2. select correct version of php image used to install composer dependancies by changing 'rasodu/cmdlaravel:7.0.2'

include .env
COMPOSE = docker-compose
PHONY =

#start server
PHONY += up
up: build
	$(COMPOSE) up -d

PHONY += build
build: vendor
	$(COMPOSE) build

vendor: composer.json
	docker run --rm --user=$$(id -u):$$(id -g) -v $$(pwd):/usr/share/nginx/WEBAPP rasodu/cmdlaravel:$(DLEMPFAST_RASODU_PHPFPMLARAVEL_VERSION).2 composer install


#access bash
PHONY += enter
enter:
	$(COMPOSE) exec --user=$$(id -u):$$(id -g) cmd bash

PHONY += enter-root
enter-root:
	$(COMPOSE) exec cmd bash


#laravel development
PHONY += watch
watch: node_modules
	$(COMPOSE) exec --user=$$(id -u):$$(id -g) cmd gulp watch

node_modules: package.json
	$(COMPOSE) exec cmd npm install --global gulp-cli
	$(COMPOSE) exec cmd npm install

PHONY += browser
browser:
	firefox http://webapp.dev:3001/ https://webapp.dev:3002/ &


#deploy
PHONY += push
push::
	docker push $(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_phpfpmlaravel:$(DLEMPFAST_PROJECT_VERSION)
	docker push $(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_httpbackendlaravelnginx:$(DLEMPFAST_PROJECT_VERSION)
	#docker push $(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_nodejs:$(DLEMPFAST_PROJECT_VERSION)

PHONY += push-repository
push-repository::
	echo $(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_phpfpmlaravel:$(DLEMPFAST_PROJECT_VERSION)
	echo $(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_httpbackendlaravelnginx:$(DLEMPFAST_PROJECT_VERSION)
	#$(DLEMPFAST_REPOSITORY_PREFIX)$(COMPOSE_PROJECT_NAME)_nodejs:$(DLEMPFAST_PROJECT_VERSION)

PHONY += aws-docker-run-copy
aws-docker-run-copy:
	if [ ! -f Dockerrun.aws.json ]; then cp "vendor/rasodu/services/other references/aws beanstalk/Dockerrun.aws.json" Dockerrun.aws.json; fi


#stop server
PHONY += mostlyclean
mostlyclean:
	$(COMPOSE) down -v --rmi local

PHONY += clean
clean:
	-$(COMPOSE) exec cmd rm -r node_modules
	-$(COMPOSE) down -v --rmi local
	-$(RM) -r vendor

#declare the contents of the PHONY variable as phony.
.PHONY: $(PHONY)
